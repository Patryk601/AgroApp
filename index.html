<!DOCTYPE html>
<html>
<head>
  <title>AgroApp - Pola</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <style>
    #map { height: 500px; }
    table { width: 100%; margin-top: 10px; border-collapse: collapse; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background-color: #eee; }
  </style>
</head>
<body>

<h2>Dodaj pole</h2>
<button onclick="startDrawing()">Dodaj pole</button>
<div id="map"></div>

<table id="fieldsTable">
  <thead>
    <tr>
      <th>Nazwa pola</th>
      <th>Miejscowość</th>
      <th>Powierzchnia (ha)</th>
      <th>Rodzaj uprawy</th>
      <th>Usuń</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
// Konfiguracja Firebase
const firebaseConfig = {
  apiKey: "AlzaSyD1AE1kvvuqVwpcfHdagXUL79Zr3J951hA",
  authDomain: "agroapp-1d397.firebaseapp.com",
  projectId: "agroapp-1d397",
  storageBucket: "agroapp-1d397.appspot.com",
  messagingSenderId: "683118014918",
  appId: "1:683118014918:web:ab3ae19ec1b521b2f142c7"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const uid = "test_uid"; // Podmień dynamicznie na zalogowanego użytkownika

// Mapa
const map = L.map('map').setView([51.25, 22.57], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

let drawnPolygon = null;
let drawing = false;
let currentLatLngs = [];

function startDrawing() {
  if (drawnPolygon) map.removeLayer(drawnPolygon);
  currentLatLngs = [];
  drawing = true;
  map.on('click', addPoint);
}

function addPoint(e) {
  currentLatLngs.push(e.latlng);
  if (currentLatLngs.length >= 3) {
    if (drawnPolygon) map.removeLayer(drawnPolygon);
    drawnPolygon = L.polygon(currentLatLngs, {color: 'blue'}).addTo(map);
    drawnPolygon.bindPopup("Nowe pole").openPopup();
    askFieldData();
    map.off('click', addPoint);
    drawing = false;
  }
}

function askFieldData() {
  const nazwaPola = prompt("Podaj nazwę pola:");
  const miejscowosc = prompt("Podaj miejscowość:");
  const rodzajUprawy = prompt("Podaj rodzaj uprawy:");
  const color = prompt("Podaj kolor (np. #3388ff):", "#3388ff");
  const powierzchnia = calculateArea(currentLatLngs);

  saveField(nazwaPola, miejscowosc, rodzajUprawy, powierzchnia, color, currentLatLngs);
}

function calculateArea(coords) {
  let area = L.GeometryUtil.geodesicArea(coords.map(latlng => [latlng.lat, latlng.lng]));
  return (area / 10000).toFixed(2); // ha
}

function saveField(name, miejscowosc, rodzajUprawy, powierzchnia, color, coords) {
  db.collection("fields").add({
    nazwapola: name,
    miejscowosc: miejscowosc,
    rodzaj_uprawy: rodzajUprawy,
    powierzchnia: powierzchnia,
    color: color,
    coordinates: coords.map(c => ({lat: c.lat, lng: c.lng})),
    userid: uid
  }).then(() => {
    alert("Pole zapisane!");
    loadFields();
  });
}

function loadFields() {
  document.querySelector("#fieldsTable tbody").innerHTML = "";
  db.collection("fields").where("userid", "==", uid).get().then(snapshot => {
    snapshot.forEach(doc => {
      const data = doc.data();
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${data.nazwapola}</td>
        <td>${data.miejscowosc}</td>
        <td>${data.powierzchnia}</td>
        <td>${data.rodzaj_uprawy}</td>
        <td><button onclick="deleteField('${doc.id}')">Usuń</button></td>
      `;
      document.querySelector("#fieldsTable tbody").appendChild(row);

      const polygon = L.polygon(data.coordinates.map(c => [c.lat, c.lng]), {color: data.color}).addTo(map);
      polygon.bindPopup(data.nazwapola);
    });
  });
}

function deleteField(id) {
  db.collection("fields").doc(id).delete().then(() => {
    alert("Pole usunięte");
    loadFields();
  });
}

loadFields();

</script>
<script src="https://unpkg.com/leaflet-geometryutil"></script>
</body>
</html>
