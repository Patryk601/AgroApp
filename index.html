<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>AgroApp - Mapa Pól</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Leaflet Draw -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
  <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <style>
    html, body, #map { height: 100%; margin: 0; padding: 0; }
  </style>
</head>

<body>

<div id="map"></div>

<script>
  // Konfiguracja Firebase
  const firebaseConfig = {
    apiKey: "AlzaSyD1AE1kvvuqVwpcfHdagXUL79Zr3J951hA",
    authDomain: "agroapp-1d397.firebaseapp.com",
    projectId: "agroapp-1d397",
    storageBucket: "agroapp-1d397.appspot.com",
    messagingSenderId: "683118014918",
    appId: "1:683118014918:web:ab3ae19ec1b521b2f142c7"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // UID użytkownika
  const urlParams = new URLSearchParams(window.location.search);
  const uid = urlParams.get('uid');

  // Mapa
  const map = L.map('map').setView([51.246, 22.568], 12);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '© OpenStreetMap'
  }).addTo(map);

  const drawnItems = new L.FeatureGroup();
  map.addLayer(drawnItems);

  const drawControl = new L.Control.Draw({
    edit: { featureGroup: drawnItems },
    draw: { polygon: true, marker: false, polyline: false, rectangle: false, circle: false, circlemarker: false }
  });
  map.addControl(drawControl);

  map.on(L.Draw.Event.CREATED, async function (event) {
    const layer = event.layer;
    drawnItems.addLayer(layer);

    const coordinates = layer.getLatLngs()[0].map(coord => ({ lat: coord.lat, lng: coord.lng }));
    const powierzchnia = L.GeometryUtil.geodesicArea(layer.getLatLngs()[0]) / 10000;
    const color = '#' + Math.floor(Math.random()*16777215).toString(16);

    const nazwa_pola = prompt('Podaj nazwę pola:');
    const miejscowosc = prompt('Podaj miejscowość:');
    const rodzaj_uprawy = prompt('Podaj rodzaj uprawy:');

    if (nazwa_pola && miejscowosc && rodzaj_uprawy) {
      try {
        await db.collection('fields').add({
          userid: uid,
          nazwa_pola: nazwa_pola,
          miejscowosc: miejscowosc,
          rodzaj_uprawy: rodzaj_uprawy,
          powierzchnia: powierzchnia.toFixed(2),
         
        });
        alert('Pole zapisane!');
      } catch (error) {
        console.error('Błąd zapisu:', error);
      }
    } else {
      alert('Wypełnij wszystkie pola!');
    }
  });

  // Wczytaj istniejące pola
  async function loadFields() {
    const snapshot = await db.collection('fields').where('userid', '==', uid).get();
    snapshot.forEach(doc => {
      const data = doc.data();
      const polygon = L.polygon(data.coordinates, { color: data.color }).addTo(map);
      polygon.bindTooltip(data.nazwa_pola || "Pole");
    });
  }

  loadFields();
</script>

</body>
</html>
