<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AgroApp Map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
</head>

<body style="margin:0; padding:0;">
  <button onclick="enableDrawing()" style="margin:10px;">Dodaj pole</button>
  <div id="map" style="width:100%; height:80vh;"></div>

  <script type="module">
    // KONFIGURACJA FIREBASE
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, query, where, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AlzaSyD1AE1kvvuqVwpcfHdagXUL79Zr3J951hA",
      authDomain: "agroapp-1d397.firebaseapp.com",
      projectId: "agroapp-1d397",
      storageBucket: "agroapp-1d397.appspot.com",
      messagingSenderId: "683118014918",
      appId: "1:683118014918:web:ab3ae19ec1b521b2f142c7"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const urlParams = new URLSearchParams(window.location.search);
    const uid = urlParams.get('uid');

    const map = L.map('map').setView([51.25, 22.57], 12);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap'
    }).addTo(map);

    const drawnItems = new L.FeatureGroup();
    map.addLayer(drawnItems);

    const drawControl = new L.Control.Draw({
      edit: {
        featureGroup: drawnItems
      },
      draw: {
        polyline: false,
        circle: false,
        rectangle: false,
        marker: false,
        circlemarker: false
      }
    });

    function enableDrawing() {
      map.addControl(drawControl);
    }

    map.on(L.Draw.Event.CREATED, async function (event) {
      const layer = event.layer;
      drawnItems.addLayer(layer);

      const area = L.GeometryUtil.geodesicArea(layer.getLatLngs()[0]) / 10000; // powierzchnia w ha

      const nazwapola = prompt("Podaj nazwę pola:");
      const miejscowosc = prompt("Podaj miejscowość:");
      const uprawa = prompt("Podaj rodzaj uprawy:");
      const color = prompt("Podaj kolor (np. red, blue, green):", "blue");

      layer.setStyle({ color: color });

      layer.bindTooltip(nazwapola, { permanent: true, direction: 'center' }).openTooltip();

      try {
        await addDoc(collection(db, "fields"), {
          nazwapola: nazwapola,
          miejscowosc: miejscowosc,
          powierzchnia: area.toFixed(2),
          uprawa: uprawa,
          color: color,
          userid: uid
        });
        alert("Pole zapisane!");
      } catch (e) {
        console.error("Błąd zapisu: ", e);
      }
    });
  </script>
</body>
</html>
